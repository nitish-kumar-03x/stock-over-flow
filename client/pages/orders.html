<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Orders - SOF</title>
    <link rel="stylesheet" href="../styles/main.css" />
    <style>
      body {
        margin: 0;
        padding: 0;
        min-height: 100vh;
        font-family: 'Segoe UI', Arial, sans-serif;
        background: #f7f4f0;
      }
      .orders-container {
        max-width: 1100px;
        margin: 2rem auto;
        padding: 1rem;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 8px 32px rgba(133, 72, 54, 0.06);
        min-height: 400px;
      }
      .orders-header {
        display: flex;
        justify-content: flex-end;
        align-items: center;
        margin-bottom: 1.5rem;
        gap: 1rem;
      }
      .order-btn {
        background-color: #ffb22c;
        color: #000;
        border: none;
        padding: 8px 32px;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        font-size: 1.1em;
        margin-left: 0.5em;
        transition: background 0.2s;
      }
      .order-btn:hover {
        background-color: #ff9800;
      }
      .filters-panel {
        width: 260px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 8px 32px rgba(133, 72, 54, 0.06);
        padding: 1.5rem 1rem 1rem 1rem;
        margin: 2rem 1.5rem 2rem 2rem;
        float: left;
        min-height: 300px;
      }
      .filters-panel h3 {
        margin-top: 0;
        color: #854836;
        font-size: 1.2rem;
        margin-bottom: 1.2rem;
      }
      .filter-group {
        margin-bottom: 1.1rem;
      }
      .filter-group label {
        display: block;
        font-size: 1em;
        color: #854836;
        margin-bottom: 0.3em;
        font-weight: 500;
      }
      .filter-group input,
      .filter-group select {
        width: 100%;
        padding: 0.5em 0.7em;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 1em;
        box-sizing: border-box;
      }
      .filter-btn {
        width: 48%;
        margin-right: 2%;
        background: #ffb22c;
        color: #000;
        border: none;
        padding: 8px 0;
        border-radius: 6px;
        cursor: pointer;
        font-weight: bold;
        margin-bottom: 0.5em;
        transition: background 0.2s;
      }
      .filter-btn:hover {
        background: #ff9800;
        color: #fff;
      }
      .filter-btn.clear {
        background: #eee;
        color: #854836;
        margin-right: 0;
      }
      .filter-btn.clear:hover {
        background: #ccc;
        color: #854836;
      }
      @media (max-width: 900px) {
        .filters-panel {
          float: none;
          width: 100%;
          margin: 1rem 0;
          display: block;
        }
        .orders-container {
          margin-left: 0;
        }
      }
      .orders-container {
        margin-left: 350px; /* leave space for filters */
      }
      @media (max-width: 900px) {
        .orders-container {
          margin-left: 0;
        }
      }
      .order-list-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1.5rem;
      }
      .order-list-table th,
      .order-list-table td {
        border: 1px solid #ddd;
        padding: 12px;
        text-align: center;
      }
      .order-list-table th {
        background-color: #ffb22c;
        color: white;
        font-weight: 600;
        font-size: 1.05em;
      }
      .order-list-table td {
        font-size: 1rem;
        color: #854836;
        background: #fff;
      }
      .icon-btn {
        background: none;
        border: none;
        cursor: pointer;
        margin: 0 2px;
        font-size: 1em;
        transition: color 0.2s;
      }
      .icon-btn:hover {
        color: #ff9800;
      }
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.4);
        display: flex;
        align-items: flex-start;
        justify-content: center;
        z-index: 999;
        padding-top: 80px;
        box-sizing: border-box;
        overflow: auto;
      }
      .modal {
        background: #fff;
        padding: 1.5rem;
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }
      .modal-fields-row {
        display: flex;
        gap: 1rem;
        margin-top: 1rem;
      }
      .modal-fields-row > * {
        flex: 1;
        min-width: 0;
      }
      .modal input,
      .modal select {
        width: 100%;
        padding: 0.6rem;
        border: 1px solid #ccc;
        border-radius: 6px;
        font-size: 1rem;
        box-sizing: border-box;
        margin-top: 0;
      }
      .modal-buttons {
        display: flex;
        justify-content: flex-end;
        margin-top: 1.5rem;
        gap: 1rem;
      }
      .modal-buttons button {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: 6px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1em;
      }
      .modal-buttons .cancel-btn {
        background: #ccc;
      }
      .modal-buttons .submit-btn {
        background: #ffb22c;
        color: white;
      }
      .product-list-modal {
        margin: 0.5em 0 1em 0;
        padding: 0.5em;
        background: #fafafa;
        border-radius: 6px;
        font-size: 0.98em;
        color: #854836;
        box-shadow: 0 2px 8px rgba(255, 178, 44, 0.07);
      }
      .product-list-modal span {
        display: inline-block;
        background: #ffb22c;
        color: #fff;
        border-radius: 12px;
        padding: 2px 12px;
        margin: 2px 6px 2px 0;
        font-size: 0.95em;
        font-weight: 500;
      }
    </style>
    <script defer src="../scripts/api.js"></script>
    <script defer src="../scripts/common.js"></script>
  </head>
  <body>
    <div id="navbar-private"></div>
    <div class="filters-panel">
      <h3>Filters</h3>
      <div class="filter-group">
        <label for="filter-product">Product</label>
        <select id="filter-product">
          <option value="">All</option>
        </select>
      </div>
      <div class="filter-group">
        <label for="filter-type">Type</label>
        <select id="filter-type">
          <option value="">All</option>
          <option value="sell">Sell</option>
          <option value="purchase">Purchase</option>
        </select>
      </div>
      <button class="filter-btn" onclick="applyOrderFilters()">
        Apply Filters
      </button>
      <button class="filter-btn clear" onclick="clearOrderFilters()">
        Clear
      </button>
    </div>
    <div class="orders-container">
      <div class="orders-header">
        <button class="order-btn" onclick="openOrderModal('add')">
          Sell / Purchase
        </button>
      </div>
      <table class="order-list-table" id="order-list-table">
        <thead>
          <tr>
            <th>S.No</th>
            <th>Product</th>
            <th>Type</th>
            <th>Quantity</th>
            <th>Price</th>
            <th>Date</th>
            <th>Point of Contact</th>
            <th>Contact Phone</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="order-table-body">
          <!-- Orders will be injected here -->
        </tbody>
      </table>
    </div>

    <!-- Modal -->
    <div id="order-modal-overlay" class="modal-overlay" style="display: none">
      <div class="modal">
        <h3 id="order-modal-title">Order</h3>
        <div class="modal-fields-row">
          <select id="order-product-input" required>
            <option value="">Select Product</option>
          </select>
          <select id="order-type-input" required>
            <option value="sell">Sell</option>
            <option value="purchase">Purchase</option>
          </select>
        </div>
        <div class="modal-fields-row">
          <input
            type="number"
            id="order-quantity-input"
            placeholder="Quantity"
            min="1"
          />
          <input
            type="number"
            id="order-price-input"
            placeholder="Price"
            min="0"
          />
        </div>
        <div class="modal-fields-row">
          <input type="date" id="order-date-input" placeholder="Date" />
        </div>
        <h3 id="pointOfContactTitle">Order</h3>
        <div class="modal-fields-row">
          <input
            type="text"
            id="order-contact-person-input"
            placeholder="Name"
          />
          <input
            type="text"
            id="order-contact-phone-input"
            placeholder="Phone Number"
            maxlength="15"
          />
        </div>
        <div class="modal-buttons">
          <button class="cancel-btn" onclick="closeOrderModal()">Cancel</button>
          <button class="submit-btn" onclick="submitOrder()">Save</button>
        </div>
      </div>
    </div>

    <script>
      let orders = [];
      let products = [];
      let modalOrderMode = 'add'; // 'add' or 'edit'
      let editOrderIndex = null;

      async function populateProductsDropdown(
        dropdownId,
        selectedProduct = ''
      ) {
        const dropdown = document.getElementById(dropdownId);
        dropdown.innerHTML = '<option value="">Select Product</option>';
        const result = await getProducts();
        if (
          result.status === 201 &&
          Array.isArray(result.data?.data?.products)
        ) {
          products = result.data.data.products;
          products.forEach((prod) => {
            const opt = document.createElement('option');
            opt.value = prod._id;
            opt.textContent = prod.name;
            dropdown.appendChild(opt);
          });
        }
        if (selectedProduct) {
          dropdown.value = selectedProduct;
        }
      }

      async function populateFilterProductsDropdown() {
        const dropdown = document.getElementById('filter-product');
        dropdown.innerHTML = '<option value="">All</option>';
        const result = await getProducts();
        if (
          result.status === 201 &&
          Array.isArray(result.data?.data?.products)
        ) {
          result.data.data.products.forEach((prod) => {
            const opt = document.createElement('option');
            opt.value = prod._id;
            opt.textContent = prod.name;
            dropdown.appendChild(opt);
          });
        }
      }

      async function fetchOrders(filter = {}) {
        const result = await getOrders(filter);
        if (result.status === 201 && Array.isArray(result.data?.data)) {
          orders = result.data.data;
        } else {
          orders = [];
        }
      }

      function clearOrderFilters() {
        document.getElementById('filter-product').value = '';
        document.getElementById('filter-type').value = '';
        applyOrderFilters();
      }

      function applyOrderFilters() {
        renderOrderList();
      }

      async function renderOrderList() {
        const tbody = document.getElementById('order-table-body');
        tbody.innerHTML = '';
        const productId = document.getElementById('filter-product').value;
        const type = document.getElementById('filter-type').value;
        let filteredOrders = orders;
        if (productId) {
          filteredOrders = filteredOrders.filter(
            (o) => o.productId === productId
          );
        }
        if (type) {
          filteredOrders = filteredOrders.filter((o) => o.type === type);
        }
        if (filteredOrders.length === 0) {
          tbody.innerHTML = `<tr><td colspan="9" style="color:#999;text-align:center;font-style:italic;">No orders found.</td></tr>`;
          return;
        }
        filteredOrders.forEach((order, idx) => {
         
          tbody.innerHTML += `
          <tr>
            <td>${idx + 1}</td>
            <td>${order.productName }</td>
            <td>${order.type.charAt(0).toUpperCase() + order.type.slice(1)}</td>
            <td>${order.quantity}</td>
            <td>₹${order.price}</td>
            <td>${formatDateDMY(order.date)}</td>
            <td>${order.contactPerson || '-'}</td>
            <td>${order.contactPhone || '-'}</td>
            <td>
              <button class="icon-btn" onclick="openOrderModal('edit', ${idx})" title="Edit"><span style="font-size:1.2em;">✏️</span></button>
              <button class="icon-btn" onclick="deleteOrder(${idx})" title="Delete"><span style="font-size:1.2em;">🗑️</span></button>
            </td>
          </tr>
        `;
        });
      }

      async function openOrderModal(mode, index = null) {
        modalOrderMode = mode;
        editOrderIndex = index;
        const overlay = document.getElementById('order-modal-overlay');
        const title = document.getElementById('order-modal-title');
        const productInput = document.getElementById('order-product-input');
        const typeInput = document.getElementById('order-type-input');
        const quantityInput = document.getElementById('order-quantity-input');
        const priceInput = document.getElementById('order-price-input');
        const dateInput = document.getElementById('order-date-input');
        const pointOfContactTitle = document.getElementById(
          'pointOfContactTitle'
        );
        const contactPersonInput = document.getElementById(
          'order-contact-person-input'
        );
        const contactPhoneInput = document.getElementById(
          'order-contact-phone-input'
        );

        if (mode === 'add') {
          title.textContent = 'Sell / Purchase';
          await populateProductsDropdown('order-product-input');
          typeInput.value = 'sell';
          quantityInput.value = '';
          priceInput.value = '';
          dateInput.value = '';
          pointOfContactTitle.textContent = 'Point of Contact Details';
          contactPersonInput.value = '';
          contactPhoneInput.value = '';
        } else if (mode === 'edit' && orders[index]) {
          const order = orders[index];
          title.textContent = 'Edit Order';
          await populateProductsDropdown(
            'order-product-input',
            order.productId
          );
          typeInput.value = order.type;
          quantityInput.value = order.quantity;
          priceInput.value = order.price;
          dateInput.value = order.date ? order.date.substr(0, 10) : '';
          contactPersonInput.value = order.contactPerson || '';
          contactPhoneInput.value = order.contactPhone || '';
        }
        overlay.style.display = 'flex';
        productInput.focus();
      }

      function closeOrderModal() {
        document.getElementById('order-modal-overlay').style.display = 'none';
      }

      function formatDateDMY(dateStr) {
        if (!dateStr) return '-';
        const d = new Date(dateStr);
        if (isNaN(d)) return '-';
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}-${month}-${year}`;
      }

      async function submitOrder() {
        const productId = document.getElementById('order-product-input').value;
        const productName =
          products.find((p) => p._id === productId)?.name || '';
        const type = document.getElementById('order-type-input').value;
        const quantity = document.getElementById('order-quantity-input').value;
        const price = document.getElementById('order-price-input').value;
        const date = document.getElementById('order-date-input').value;
        const contactPerson = document
          .getElementById('order-contact-person-input')
          .value.trim();
        const contactPhone = document
          .getElementById('order-contact-phone-input')
          .value.trim();

        if (
          !productId ||
          !type ||
          !quantity ||
          !price ||
          !date ||
          !contactPerson ||
          !contactPhone
        ) {
          alert('All fields are required.');
          return;
        }

        if (modalOrderMode === 'add') {
          const result = await createOrder({
            productId,
            productName,
            type,
            quantity,
            price,
            date,
            contactPerson,
            contactPhone,
          });
          if (result.status == 201) {
            showToast('Order Added');
            renderOrderList();
          }
        }
        closeOrderModal();
      }

      function deleteOrder(index) {
        if (confirm('Are you sure you want to delete this order?')) {
          orders.splice(index, 1);
          showToast('Order Deleted');
          renderOrderList();
        }
      }

      function showToast(msg) {
        alert(msg);
      }

      document.addEventListener('DOMContentLoaded', async () => {
        await populateFilterProductsDropdown();
        await fetchOrders();
        renderOrderList();
      });
    </script>
  </body>
</html>
